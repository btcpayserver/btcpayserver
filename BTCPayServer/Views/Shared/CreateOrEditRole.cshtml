@using BTCPayServer.Client
@using BTCPayServer.Views.Server
@using Microsoft.AspNetCore.Mvc.TagHelpers
@using BTCPayServer.Abstractions.TagHelpers
@using BTCPayServer.Controllers
@using BTCPayServer.Views.Stores
@model UpdateRoleViewModel
@inject BTCPayServer.Services.PluginPermissionRegistry PluginPermissionRegistry
@{
    var role = Context.GetRouteValue("role") as string;

    if (role == "create")
        role = null;

    var storeId = Context.GetRouteValue("storeId") as string;
    var title = role is null ? StringLocalizer["Create role"] : StringLocalizer["Update Role"];
    var category = storeId is null ? WellKnownCategories.Server : WellKnownCategories.Store;
    ViewData.SetLayoutModel(new LayoutModel(nameof(StoreNavPages.Roles), title).SetCategory(category));
    var storePolicies = Policies.AllPolicies.Where(Policies.IsStorePolicy).ToArray();
    var pluginPermissions = Model.PluginPermissions ?? new List<BTCPayServer.Abstractions.Contracts.PluginPermission>();
    // Collect all child policy strings so we can identify top-level permissions
    var allChildPolicies = new HashSet<string>(pluginPermissions.SelectMany(p => (p.ChildPolicies ?? new List<BTCPayServer.Abstractions.Contracts.PluginPermission>()).Select(c => c.Policy)));
    // Walk deeper levels too
    void CollectAllChildren(IEnumerable<BTCPayServer.Abstractions.Contracts.PluginPermission> perms, HashSet<string> set)
    {
        foreach (var p in perms)
        {
            foreach (var c in p.ChildPolicies ?? new List<BTCPayServer.Abstractions.Contracts.PluginPermission>())
            {
                set.Add(c.Policy);
                CollectAllChildren(new[] { c }, set);
            }
        }
    }
    CollectAllChildren(pluginPermissions, allChildPolicies);
    var topLevelPluginPermissions = pluginPermissions.Where(p => !allChildPolicies.Contains(p.Policy)).ToList();
    var orphanedPermissions = Model.Policies?
        .Where(p => Policies.IsPluginPolicy(p) && !pluginPermissions.Any(pp => pp.Policy == p))
        .ToList() ?? new List<string>();

    // We resolve display names through a helper because core and plugin permissions currently come from different sources.
    string GetPermissionDisplayName(string policy) =>
        (PluginPermissionRegistry?.GetDisplayName(policy)) ?? Policies.DisplayName(policy);
}

<form method="post">
    <div class="sticky-header">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a asp-action="ListRoles" asp-route-storeId="@storeId">Roles</a>
                </li>
                <li class="breadcrumb-item active" aria-current="page">@ViewData["Title"]</li>
            </ol>
            <h2>@ViewData["Title"]</h2>
        </nav>
        <button id="page-primary" type="submit" class="btn btn-primary" name="command" value="Save" text-translate="true">Save</button>
    </div>

    <div class="row">
        <div class="col-xxl-constrain">
            @if (!ViewContext.ModelState.IsValid)
            {
                <div asp-validation-summary="ModelOnly"></div>
            }
            <div class="form-group" style="max-width:320px">
                <label asp-for="Role" class="form-label"></label>
                @if (role == null)
                {
                    <input asp-for="Role" required="required" class="form-control" />
                }
                else
                {
                    <input type="hidden" asp-for="Role" />
                    <input required="required" class="form-control" disabled value="@Model.Role" />
                }
                <span asp-validation-for="Role" class="text-danger"></span>
            </div>

            <h4 class="mt-4 mb-3">Permissions</h4>
            <select multiple="multiple" asp-for="Policies" class="form-select hide-when-js">
                @foreach (var policy in storePolicies)
                {
                    <option value="@policy" class="text-truncate" asp-selected="@(Model.Policies?.Contains(policy) ?? false)">@policy</option>
                }
                @* Add plugin permissions to the select so they get submitted *@
                @if (pluginPermissions.Any())
                {
                    foreach (var pluginPermission in pluginPermissions)
                    {
                        <option value="@pluginPermission.Policy" class="text-truncate" asp-selected="@(Model.Policies?.Contains(pluginPermission.Policy) ?? false)">@pluginPermission.Policy</option>
                    }
                }
                @* Add orphaned plugin permissions to the select so they get submitted *@
                @foreach (var orphanedPolicy in orphanedPermissions)
                {
                    <option value="@orphanedPolicy" class="text-truncate" selected="selected">@orphanedPolicy</option>
                }
            </select>
            <div class="list-group mb-2">
                @{
                    var storePolicyMap = Permission.PolicyMap.Where(pair => Policies.IsStorePolicy(pair.Key)).ToArray();
                    var topMostPolicies = storePolicyMap.Where(pair => !storePolicyMap.Any(valuePair => valuePair.Value.Contains(pair.Key)));
                    @foreach (var policy in topMostPolicies)
                    {
                        RenderTree(policy, storePolicyMap, Model.Policies.Contains(policy.Key));
                    }
                }
            </div>
            
            @* Plugin Permissions Section *@
            @if (pluginPermissions.Any())
            {
                <h5 class="mt-4 mb-3">Plugin Permissions</h5>
                <div class="list-group mb-2">
                    @foreach (var pluginPermission in topLevelPluginPermissions)
                    {
                        var isChecked = Model.Policies?.Contains(pluginPermission.Policy) ?? false;
                        RenderPluginTree(pluginPermission, isChecked);
                    }
                </div>
            }
            
            @* Orphaned Plugin Permissions Section *@
            @if (orphanedPermissions.Any())
            {
                <div class="alert alert-warning mt-4" role="alert">
                    <h5 class="alert-heading">
                        <i class="fa fa-exclamation-triangle me-2"></i>
                        Orphaned Plugin Permissions
                    </h5>
                    <p class="mb-2">The following permissions are from plugins that are no longer installed. They will not grant any access but are preserved in case you reinstall the plugin.</p>
                    <div class="list-group">
                        @foreach (var orphanedPolicy in orphanedPermissions)
                        {
                            <div class="form-check mb-2">
                                <input type="checkbox" class="form-check-input policy-cb" checked="true" value="@orphanedPolicy" id="Policy-@orphanedPolicy.Replace(".", "_")" />
                                <label class="form-check-label text-warning" for="Policy-@orphanedPolicy.Replace(".", "_")">
                                    <strong>@GetPermissionDisplayName(orphanedPolicy)</strong>
                                </label>
                                <small class="text-muted d-block">@orphanedPolicy</small>
                            </div>
                        }
                    </div>
                </div>
            }
            
            <span asp-validation-for="Policies" class="text-danger"></span>
        </div>
    </div>
</form>

@{
    void RenderTree(KeyValuePair<string, HashSet<string>> policy, KeyValuePair<string, HashSet<string>>[] storePolicyMap, bool isChecked)
    {
        <div class="form-check mb-0">
            <input type="checkbox" class="form-check-input policy-cb" checked="@isChecked" value="@policy.Key" id="Policy-@policy.Key.Replace(".", "_")" />
            @{
                string title;
                string description;
                
                // Check if this is a plugin permission or core permission
                if (UIManageController.AddApiKeyViewModel.PermissionValueItem.PermissionDescriptions.ContainsKey(policy.Key))
                {
                    title = UIManageController.AddApiKeyViewModel.PermissionValueItem.PermissionDescriptions[policy.Key].Title;
                    description = UIManageController.AddApiKeyViewModel.PermissionValueItem.PermissionDescriptions[policy.Key].Description;
                }
                else
                {
                    title = GetPermissionDisplayName(policy.Key);
                    description = policy.Key; // Use policy string as description for now
                }
            }
            <label class="h5 fw-semibold form-check-label mb-1" for="Policy-@policy.Key.Replace(".", "_")" data-bs-toggle="tooltip" title="@policy.Key">
                @title
            </label>
            <p class="text-muted">@description</p>
            @if (policy.Value?.Any() is true)
            {
                <div class="list-group">
                    @foreach (var subPolicy in policy.Value)
                    {
                        var match = storePolicyMap.SingleOrDefault(pair => pair.Key == subPolicy);
                        RenderTree(match.Key is not null ? match : new KeyValuePair<string, HashSet<string>>(subPolicy, null), storePolicyMap, !isChecked && Model.Policies.Contains(subPolicy));
                    }
                </div>
            }
        </div>
    }

    void RenderPluginTree(BTCPayServer.Abstractions.Contracts.PluginPermission permission, bool isChecked)
    {
        <div class="form-check mb-0">
            <input type="checkbox" class="form-check-input policy-cb" checked="@isChecked" value="@permission.Policy" id="Policy-@permission.Policy.Replace(".", "_")" />
            <label class="h5 fw-semibold form-check-label mb-1" for="Policy-@permission.Policy.Replace(".", "_")" data-bs-toggle="tooltip" title="@permission.Policy">
                @permission.DisplayName
            </label>
            <p class="text-muted">@permission.Description</p>
            @if (permission.ChildPolicies?.Any() is true)
            {
                <div class="list-group">
                    @foreach (var child in permission.ChildPolicies)
                    {
                        RenderPluginTree(child, !isChecked && (Model.Policies?.Contains(child.Policy) ?? false));
                    }
                </div>
            }
        </div>
    }
}
<script>
    function handleCheckboxChange(element) {
        const { checked, value: policy } = element;
        const policySelect = document.getElementById('Policies');
        const subPolicies = element.parentElement.querySelectorAll(`.list-group .policy-cb:not([value="${policy}"])`);

        const option = policySelect.querySelector(`option[value="${policy}"]`);
        if (option) {
            option.selected = checked;
        }
        
        subPolicies.forEach(subPolicy => {
            subPolicy.checked = checked? false : subPolicy.checked;
            if (checked){
                subPolicy.setAttribute("disabled", "disabled");
            } else {
                subPolicy.removeAttribute("disabled");
            }
            const subOption = policySelect.querySelector(`option[value="${subPolicy.value}"]`);
            if (subOption) {
                subOption.selected = subPolicy.checked;
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll(".policy-cb:checked").forEach(handleCheckboxChange);

        delegate('change', '.policy-cb', event => {
           handleCheckboxChange(event.target);
        });
        
        // Before form submission, ensure all checked checkboxes are reflected in the select
        document.querySelector('form').addEventListener('submit', (e) => {
            const policySelect = document.getElementById('Policies');
            document.querySelectorAll('.policy-cb').forEach(checkbox => {
                const option = policySelect.querySelector(`option[value="${checkbox.value}"]`);
                if (option) {
                    option.selected = checkbox.checked;
                }
            });
        });
    });
</script>
